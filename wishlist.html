
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Избранное | The X Shop</title>
    <meta name="description" content="Избранные товары в The X Shop - товары из Китая для вашего дома" />
    <meta name="keywords" content="избранное, понравившиеся товары, the x shop, товары из китая" />
    
    <!-- CSS стили -->
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <header class="header">
      <div class="container header-container">
        <div class="header-left">
          <a href="index.html" class="logo">The X Shop</a>
          <nav class="main-nav">
            <ul>
              <li><a href="index.html">Главная</a></li>
              <li><a href="catalog.html">Каталог</a></li>
              <li><a href="about.html">О нас</a></li>
              <li><a href="contacts.html">Контакты</a></li>
            </ul>
          </nav>
        </div>
        <div class="header-actions">
          <button class="icon-button search-button" aria-label="Поиск">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
          </button>
          <a href="wishlist.html" class="icon-button" aria-label="Избранное">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg>
          </a>
          <a href="cart.html" class="icon-button" aria-label="Корзина">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"></circle><circle cx="19" cy="21" r="1"></circle><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path></svg>
            <span class="cart-counter"></span>
          </a>
          <a href="/login" class="icon-button" aria-label="Личный кабинет">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          </a>
        </div>
      </div>
    </header>

    <main>
      <div class="container py-8">
        <h1 class="page-title">Избранное</h1>
        
        <div id="wishlist-container">
          <!-- Содержимое будет загружено с помощью JavaScript -->
          <div class="loading">Загрузка избранных товаров...</div>
        </div>
      </div>
        <div class="chat-widget">
          <button id="chat-button" class="chat-toggle-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
          </button>
          <div id="chat-container" class="chat-container hidden">
            <!-- Chat interface will be loaded here -->
          </div>
        </div>
      </main>
    
    <footer class="footer">
      <div class="container">
        <div class="footer-grid">
          <div class="footer-column">
            <h4>The X Shop</h4>
            <p>Товары из Китая для вашего дома</p>
          </div>
          <div class="footer-column">
            <h4>Информация</h4>
            <ul>
              <li><a href="about.html">О нас</a></li>
              <li><a href="delivery.html">Доставка</a></li>
            </ul>
          </div>
          <div class="footer-column">
            <h4>Помощь</h4>
            <ul>
              <li><a href="terms.html">Условия использования</a></li>
              <li><a href="privacy.html">Политика конфиденциальности</a></li>
            </ul>
          </div>

        </div>
        <div class="footer-bottom">
          <p>&copy; 2020 The X Shop. Все права защищены.</p>
        </div>
      </div>
    </footer>

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript" >
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

       ym(101964387, "init", {
            defer: true,
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true,
            ecommerce:"dataLayer"
       });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/101964387" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
    
    <!-- Скрипты для функциональности страницы -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="scripts.js"></script>
    <script src="js/chat.js"></script>
    
    <!-- Скрипт для избранного -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        renderWishlist();
      });
      
      async function renderWishlist() {
        const wishlistContainer = document.getElementById('wishlist-container');
        const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
        
        if (wishlist.length === 0) {
          wishlistContainer.innerHTML = `
            <div class="empty-message">
              <p>У вас нет избранных товаров</p>
              <div class="section-actions" style="margin-top: 2rem;">
                <a href="catalog.html" class="btn btn-primary">Перейти в каталог</a>
              </div>
            </div>
          `;
          return;
        }
        
        wishlistContainer.innerHTML = `<div class="loading">Загрузка избранных товаров...</div>`;
        
        try {
          // Собираем все идентификаторы товаров в строку для запроса
          const productIds = wishlist.map(id => `id=eq.${id}`).join('&');
          
          // Отправляем запрос в Supabase для получения товаров
          const response = await fetch(`https://lpwvhyawvxibtuxfhitx.supabase.co/rest/v1/products?${productIds}`, {
            headers: {
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxwd3ZoeWF3dnhpYnR1eGZoaXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1MzIyOTUsImV4cCI6MjA2MjEwODI5NX0.-2aL1s3lUq4Oeos9jWoEd0Fn1g_-_oaQ_QWVEDByaOI',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxwd3ZoeWF3dnhpYnR1eGZoaXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1MzIyOTUsImV4cCI6MjA2MjEwODI5NX0.-2aL1s3lUq4Oeos9jWoEd0Fn1g_-_oaQ_QWVEDByaOI'
            }
          });
          
          if (!response.ok) {
            throw new Error(`Ошибка HTTP: ${response.status}`);
          }
          
          const products = await response.json();
          
          // Создаем HTML для списка избранных товаров
          if (products.length === 0) {
            wishlistContainer.innerHTML = `
              <div class="empty-message">
                <p>Товары из вашего списка избранного не найдены</p>
                <div class="section-actions" style="margin-top: 2rem;">
                  <a href="catalog.html" class="btn btn-primary">Перейти в каталог</a>
                </div>
              </div>
            `;
            return;
          }
          
          let productsHTML = '<div class="products-grid">';
          
          products.forEach(product => {
            const priceDisplay = product.discount_price 
              ? `<span class="old-price">${product.price} ₽</span><span class="current-price">${product.discount_price} ₽</span>` 
              : `<span class="current-price">${product.price} ₽</span>`;
            
            productsHTML += `
              <div class="product-card">
                <div class="product-image">
                  <a href="product-${generateSlug(product.title)}.html" class="product-link" data-id="${product.id}">
                    <img src="${product.image_url}" alt="${product.title}" loading="lazy">
                  </a>
                  <button class="wishlist-button active" aria-label="Удалить из избранного">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg>
                  </button>
                </div>
                <div class="product-info">
                  <h3>
                    <a href="product-${generateSlug(product.title)}.html" class="product-link" data-id="${product.id}">${product.title}</a>
                  </h3>
                  <div class="product-price">
                    ${priceDisplay}
                  </div>
                  <button class="add-to-cart-btn">В корзину</button>
                </div>
              </div>
            `;
          });
          
          productsHTML += '</div>';
          wishlistContainer.innerHTML = productsHTML;
          
          // Инициализируем обработчики для кнопок после рендеринга
          initAddToCartButtons();
          initWishlistButtons();
          
        } catch (error) {
          console.error('Ошибка при загрузке избранных товаров:', error);
          wishlistContainer.innerHTML = `
            <div class="error-message">
              <p>Ошибка при загрузке избранных товаров</p>
              <div class="section-actions" style="margin-top: 2rem;">
                <a href="catalog.html" class="btn btn-primary">Перейти в каталог</a>
              </div>
            </div>
          `;
        }
      }
    </script>
  </body>
</html>
